<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../cedar-alert/cedar-alert.html">
<link rel="import" href="../birch-standards-picker/birch-standards-picker.html">
<link rel="import" href="../wc-i18n/wc-i18n.html">
<link rel="import" href="../fs-styles/fs-styles.html">
<link rel="import" href="../fs-button/fs-button.html">

<!--
An element providing a solution to no problem in particular.

Example:

    <birch-standards-picker-wrapper></birch-standards-picker-wrapper>

@demo demo/index.html
@hero hero.svg
-->

<dom-module id="birch-standards-picker-wrapper">
  <style include='fs-styles'></style>
  <link rel="import" type="css" href="birch-standards-picker-wrapper.css">
  <template>
    <wc-i18n-src locale='[[_lang]]' locale-dir='[[localeDir()]]' domain='birch-standards-picker-wrapper'></wc-i18n-src>
    <wc-i18n key='birch-standards-picker-wrapper.add' provider value='{{_i18nAdd}}'></wc-i18n>
    <wc-i18n key='birch-standards-picker-wrapper.edit' provider value='{{_i18nEdit}}'></wc-i18n>
    <wc-i18n key='birch-standards-picker-wrapper.delete' provider value='{{_i18nDelete}}'></wc-i18n>
    <wc-i18n key='birch-standards-picker-wrapper.event_place' provider value='{{_i18nEventPlace}}'></wc-i18n>
    <wc-i18n key='birch-standards-picker-wrapper.event_date' provider value='{{_i18nEventDate}}'></wc-i18n>
    <wc-i18n key='birch-standards-picker-wrapper.add_event_place' provider value='{{_i18nAddEventPlace}}'></wc-i18n>
    <wc-i18n key='birch-standards-picker-wrapper.add_event_date' provider value='{{_i18nAddEventDate}}'></wc-i18n>
    <wc-i18n key='birch-standards-picker-wrapper.unable_to_save_date' provider value='{{_i18nSaveDateError}}'></wc-i18n>
    <wc-i18n key='birch-standards-picker-wrapper.unable_to_save_place' provider value='{{i18nSavePlaceError}}'></wc-i18n>

    <template is="dom-if" if="[[_same(mode, 'view')]]">
      <div id="view">
        <div class="top">

          <template is="dom-if" if="[[_same(standardType, 'date')]]">
            <span>[[_i18nEventDate]]</span>
          </template>

          <template is="dom-if" if="[[_same(standardType, 'place')]]">
            <span>[[_i18nEventPlace]]</span>
          </template>

          <button
            is="fs-button"
            on-tap="_editMode"
            option="minor">
            [[_i18nEdit]]
          </button>

          <button
            is="fs-button"
            on-tap="_addMode"
            option="minor">
            [[_i18nDelete]]
          </button>
        </div>
        <div class="main">

          <template is="dom-if" if="[[_hasText(originalText, standardText)]]">
            [[_getText(originalText, standardText)]]
          </template>

          <template is="dom-if" if="[[!_hasText(originalText, standardText)]]">
            <button
              is="fs-button"
              on-tap="_addMode"
              option="minor">
              [[_i18nAdd]]
            </button>
          </template>

        </div>
      </div>
    </template>

    <template is="dom-if" if="[[_same(mode, 'add', 'edit')]]">
      <cedar-alert id="alert" alert-type="error" hidden>
        <template is="dom-if" if="[[_same(standardType, 'date')]]">
          [[_i18nSaveDateError]]
        </template>
        <template is="dom-if" if="[[_same(standardType, 'place')]]">
          [[i18nSavePlaceError]]
        </template>
      </cedar-alert>

      <birch-standards-picker id="picker"
        hide-standards-dropdown
        standard-type="[[standardType]]"
        original-text="[[originalText]]"
        standard-text="[[standardText]]"
        standard-id="[[standardId]]"
        on-birch-typeahead:input="_handleInput"
        on-birch-typeahead:selected="_handleSelection"
        ></birch-standards-picker/>

      <button id="save-button"
        is="fs-button"
        on-tap="_handleSave"
        option="recommended"
        loading="[[_loading]]"
        disabled$="[[_disableSaveButton]]">
        <wc-i18n key='birch-standards-picker-wrapper.save'></wc-i18n>
      </button>

      <button id="cancel-button"
        is="fs-button"
        on-tap="_viewMode"
        option="minor">
        <wc-i18n key='birch-standards-picker-wrapper.cancel'></wc-i18n>
      </button>
    </template>
  </template>

  <script>
    Polymer({
      is: 'birch-standards-picker-wrapper',

      behaviors: [
        WCI18nBehavior
      ],

      properties: {
        mode: {
          type: String,
          value: 'view'
        },

        originalText: {
          type: String,
          value: ''
        },

        standardText: {
          type: String,
          value: ''
        },

        standardId: {
          type: String,
          value: ''
        },

        standardType: {
          type: String,
          value: ''
        },

        _loading: {
          type: Boolean,
          value: false
        },

        _disableSaveButton: {
          type: Boolean,
          value: true
        }
      },

      reset: function() {
        this.$$('#alert').hide();
        this.$$('#picker')._handleChange({
          detail: {value: ''}
        });
        this.$$('#picker').$.typeahead.loading = false;
        this._disableSaveButton = true;
        this.$$('#picker').hideStandardsDropdown = true;
        this.async(function(){
          this.$$('#picker').$.typeahead.$.input.focus();
        }, 100);
      },

      showErrorAlert: function() {
        this.$$('#alert').show();
        this._loading = false;
        this._disableSaveButton = false;
      },

      _viewMode: function() {
        this.mode = 'view';
      },

      _addMode: function() {
        this.mode = 'add';
      },

      _editMode: function() {
        this.mode = 'edit';
      },

      _getViewEventString: function(standardType) {
        return standardType === 'date' ? this._i18nEventDate : this._i18nEventPlace;
      },

      _hasText: function(originalText, standardText) {
        return !!(originalText || standardText);
      },

      _getText: function(originalText, standardText) {
        return originalText || standardText;
      },

      _handleSelection: function(e) {
        if(!e || !e.detail || !e.detail.selection) return;
        this._disableSaveButton = false;
        this.$$('#picker').hideStandardsDropdown = false;
      },

      _handleInput: function(e) {
        if(!e || !e.detail || !e.detail.value) {
          this.$$('#picker').$.typeahead.loading = false;
          this.$$('#picker').hideStandardsDropdown = true;
        }
        this._disableSaveButton = true;
      },

      _handleSave: function(e) {
        if(this._disableSaveButton) return;
        this.fire('birch-standards-picker-wrapper:save', {
          originalText: this.originalText,
          standardText: this.standardText,
          standardId: this.standardId
        });
      },

      _same: function(a, b, c) {
        return a === b || a === c;
      }
    });
  </script>
</dom-module>
