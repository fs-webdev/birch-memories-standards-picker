<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../cedar-alert/cedar-alert.html">
<link rel="import" href="../birch-standards-picker/birch-standards-picker.html">
<link rel="import" href="../wc-i18n/wc-i18n.html">
<link rel="import" href="../fs-styles/fs-styles.html">
<link rel="import" href="../fs-button/fs-button.html">

<!--
An element providing a solution to no problem in particular.

Example:

    <birch-standards-picker-wrapper></birch-standards-picker-wrapper>

@demo demo/index.html
@hero hero.svg
-->

<dom-module id="birch-standards-picker-wrapper">
  <style include='fs-styles'></style>
  <link rel="import" type="css" href="birch-standards-picker-wrapper.css">
  <template>
    <wc-i18n-src locale='[[_lang]]' locale-dir='[[localeDir()]]' domain='birch-standards-picker-wrapper'></wc-i18n-src>
    <wc-i18n key='birch-standards-picker-wrapper.add_event_place' provider value='{{_add_event_place}}'></wc-i18n>
    <wc-i18n key='birch-standards-picker-wrapper.add_event_date' provider value='{{_add_event_date}}'></wc-i18n>
    <wc-i18n key='birch-standards-picker-wrapper.unable_to_save_date' provider value='{{_save_date_error}}'></wc-i18n>
    <wc-i18n key='birch-standards-picker-wrapper.unable_to_save_place' provider value='{{_save_place_error}}'></wc-i18n>

    <template is="dom-if" if="[[_same(mode, 'view')]]">
    </template>

    <template is="dom-if" if="[[_same(mode, 'add', 'edit')]]">
      <cedar-alert id="alert" alert-type="error" hidden>
        <template is="dom-if" if="[[_same(standardType, 'date')]]">
          [[_save_date_error]]
        </template>
        <template is="dom-if" if="[[_same(standardType, 'place')]]">
          [[_save_place_error]]
        </template>
      </cedar-alert>

      <birch-standards-picker id="picker"
        hide-standards-dropdown
        standard-type="[[standardType]]"
        original-text="[[originalText]]"
        standard-text="[[standardText]]"
        standard-id="[[standardId]]"
        on-birch-typeahead:input="_handleInput"
        on-birch-typeahead:selected="_handleSelection"
        ></birch-standards-picker/>

      <button id="save-button"
        is="fs-button"
        on-tap="_handleSave"
        option="recommended"
        loading="[[_loading]]"
        disabled$="[[_disableSaveButton]]">
        <wc-i18n key='birch-standards-picker-wrapper.save'></wc-i18n>
      </button>

      <button id="cancel-button"
        is="fs-button"
        on-tap="_handleCancel"
        option="minor"
        disabled$="[[_disableSaveButton]]">
        <wc-i18n key='birch-standards-picker-wrapper.cancel'></wc-i18n>
      </button>
    </template>
  </template>

  <script>
    Polymer({
      is: 'birch-standards-picker-wrapper',

      behaviors: [
        WCI18nBehavior
      ],

      properties: {
        mode: {
          type: String,
          value: 'view'
        },

        originalText: {
          type: String,
          value: ''
        },

        standardText: {
          type: String,
          value: ''
        },

        standardId: {
          type: String,
          value: ''
        },

        standardType: {
          type: String,
          value: ''
        },

        _loading: {
          type: Boolean,
          value: false
        },

        _disableSaveButton: {
          type: Boolean,
          value: true
        }
      },

      reset: function() {
        this.$$('#alert').hide();
        this.$$('#picker')._handleChange({
          detail: {value: ''}
        });
        this.$$('#picker').$.typeahead.loading = false;
        this._disableSaveButton = true;
        this.$$('#picker').hideStandardsDropdown = true;
        this.async(function(){
          this.$$('#picker').$.typeahead.$.input.focus();
        }, 100);
      },

      showErrorAlert: function() {
        this.$$('#alert').show();
        this._loading = false;
        this._disableSaveButton = false;
      },

      _handleSelection: function(e) {
        if(!e || !e.detail || !e.detail.selection) return;
        this._disableSaveButton = false;
        this.$$('#picker').hideStandardsDropdown = false;
      },

      _handleInput: function(e) {
        if(!e || !e.detail || !e.detail.value) {
          this.$$('#picker').$.typeahead.loading = false;
          this.$$('#picker').hideStandardsDropdown = true;
        }
        this._disableSaveButton = true;
      },

      _handleSave: function(e) {
        if(this._disableSaveButton) return;
        this.fire('birch-standards-picker-wrapper:save', {
          originalText: this.originalText,
          standardText: this.standardText,
          standardId: this.standardId
        });
      },

      _handleCancel: function(e) {
        this.fire('birch-standards-picker-wrapper:cancel');
      },

      _same: function(a, b, c) {
        return a === b || a === c;
      }
    });
  </script>
</dom-module>
