<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../cedar-alert/cedar-alert.html">
<link rel="import" href="../birch-standards-picker/birch-standards-picker.html">
<link rel="import" href="../wc-i18n/wc-i18n.html">
<link rel="import" href="../fs-styles/fs-styles.html">
<link rel="import" href="../fs-button/fs-button.html">
<link rel="import" href="../oak-i18n-behavior/oak-i18n-behavior.html">

<!--
An element providing a solution to no problem in particular.

Example:

    <birch-standards-picker-wrapper></birch-standards-picker-wrapper>

@demo demo/index.html
@hero hero.svg
-->

<dom-module id="birch-standards-picker-wrapper">
  <style include='fs-styles'></style>
  <link rel="import" type="css" href="birch-standards-picker-wrapper.css">
  <template>

    <template is="dom-if" if="[[_same(mode, 'view')]]">
      <div id="view">
        <div class="top">

          <small class="flex-item vertical-center">[[_getStandardTypeText(i18n, standardType)]]</small>

          <template is="dom-if" if="[[_hasText(data)]]">
            <button
              is="fs-button"
              on-tap="_editMode"
              option="minor"
              class="flex-item edit-delete-button">
              [[i18n('edit')]]
            </button>

            <small class="flex-item vertical-center">|</small>

            <button
              is="fs-button"
              on-tap=""
              option="minor"
              class="flex-item edit-delete-button">
              [[i18n('delete')]]
            </button>
          </template>
        </div>

        <div class="main vertical-center">
          <template is="dom-if" if="[[_hasText(data)]]">
            <p>[[_getText(data)]]</p>
          </template>

          <template is="dom-if" if="[[!_hasText(data)]]">
            <button
              is="fs-button"
              on-tap="_editMode"
              option="minor">
              [[i18n('add')]]
            </button>
          </template>
        </div>
      </div>
    </template>

    <template is="dom-if" if="[[_same(mode, 'edit')]]">
      <cedar-alert id="alert" alert-type="error" hidden>
        <template is="dom-if" if="[[_same(standardType, 'date')]]">
          [[i18n('unable_to_save_date')]]
        </template>
        <template is="dom-if" if="[[_same(standardType, 'place')]]">
          [[i18n('unable_to_save_place')]]
        </template>
      </cedar-alert>

      <birch-standards-picker id="picker"
        data="[[data]]"
        search-term="[[_getText(data)]]"
        standard-type="[[standardType]]"
        on-birch-typeahead:input="_handleInput"
        on-birch-typeahead:selected="_handleSelection">
      </birch-standards-picker/>

      <div class="save-cancel-buttons vertical-center">
        <button id="save-button"
          is="fs-button"
          on-tap="_handleSave"
          option="recommended"
          loading="[[loading]]"
          disabled$="[[_disableSaveButton]]">
          [[i18n('save')]]
        </button>

        <button id="cancel-button"
          is="fs-button"
          on-tap="_viewMode"
          option="minor">
          [[i18n('cancel')]]
        </button>
      </div>
    </template>
  </template>

  <script>
    Polymer({
      is: 'birch-standards-picker-wrapper',

      behaviors: [
        OakI18nBehavior,
        WCI18n()
      ],

      properties: {
        mode: {
          type: String,
          value: 'view'
        },

        data: {
          type: Object,
          value: function(){ return {}; }
        },

        standardType: {
          type: String,
          value: 'date'
        },

        loading: {
          type: Boolean,
          value: false
        },

        _disableSaveButton: {
          type: Boolean,
          value: true
        }
      },

      listeners: {
        'birch-standards-picker:update-data': '_handleDataChange',
        'birch-standards-picker:error': '_handleError'
      },

      reset: function() {
        var picker = this.$$('#picker');
        var alert = this.$$('#alert');
        if(picker){
          picker.reset();
          picker.data = this.data;
          picker.$.typeahead.$.input.focus();
        }
        if(alert){
          alert.hide();
        }
        this._disableSaveButton = true;
      },

      showErrorAlert: function() {
        this.$$('#alert').show();
        this.loading = false;
      },

      _updateData: function(data) {
        this.data = Object.assign({}, data);
      },

      _handleDataChange: function(data) {
        if(this.mode === 'view' || Object.keys(data).length === 0){
          this._disableSaveButton = true;
        } else {
          this._disableSaveButton = false;
        }
      },

      _handleError: function(e) {
        this.$$('#alert').show();
      },

      _viewMode: function() {
        this.reset();
        this.mode = 'view';
      },

      _editMode: function() {
        this._updateData(this.data);
        this.mode = 'edit';
      },

      _getViewEventString: function(standardType) {
        return standardType === 'date' ? this._i18nEventDate : this._i18nEventPlace;
      },

      _hasText: function(data) {
        return !!(data.customText || data.standardText);
      },

      _getText: function(data) {
        return data.customText || data.standardText;
      },

      _handleSelection: function(e) {
        if(!e || !e.detail || !e.detail.selection) return;
        this._disableSaveButton = false;
        this.$$('#picker').hideStandardsDropdown = false;
      },

      _handleInput: function(e) {
        this._disableSaveButton = true;
      },

      _handleSave: function(e) {
        if(this._disableSaveButton) return;
        this.data = this.$$('#picker').data;
        this.fire('birch-standards-picker-wrapper:save', this.data);
        this._disableSaveButton = true;
        this.mode = 'view';
      },

      _handleDelete: function(e) {
        this.fire('birch-standards-picker-wrapper:delete', this.data);
      },

      _getStandardTypeText: function(i18n, standardType) {
        return standardType === 'date' ? i18n('event_date') : i18n('event_place');
      },

      _same: function(a, b, c) {
        return a === b || a === c;
      }
    });
  </script>
</dom-module>
